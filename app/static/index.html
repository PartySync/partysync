<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="description" content="A front-end template that helps you build fast, modern mobile web apps.">
        <meta name="viewport" content="width=device-width, initial-scale=1, minimal-ui">
        <title>You Party</title>

        <!-- Add to homescreen for Chrome on Android -->
        <meta name="mobile-web-app-capable" content="yes">

        <!-- iOS icons -->
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="images/touch/apple-touch-icon-144x144-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="images/touch/apple-touch-icon-114x114-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="images/touch/apple-touch-icon-72x72-precomposed.png">
        <link rel="apple-touch-icon-precomposed" href="images/touch/apple-touch-icon-57x57-precomposed.png">

        <!-- Tile icon for Win8 (144x144 + tile color) -->
        <meta name="msapplication-TileImage" content="images/touch/ms-touch-icon-144x144-precomposed.png">
        <meta name="msapplication-TileColor" content="#3372DF">

        <!-- Generic Icon -->
        <link rel="shortcut icon" href="images/touch/touch-icon-57x57.png">

        <!-- SEO: If mobile URL is different from desktop URL, add a canonical link to the desktop page https://developers.google.com/webmasters/smartphone-sites/feature-phones -->
        <!--
        <link rel="canonical" href="http://www.example.com/">
        -->
        
        <!-- Chrome Add to Homescreen -->
        <link rel="shortcut icon" sizes="196x196" href="images/touch/touch-icon-196x196.png">

        <!-- For iOS web apps. Delete if not needed. https://github.com/h5bp/mobile-boilerplate/issues/94 -->
        <!--
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <meta name="apple-mobile-web-app-title" content="">
        -->

        <!-- build:css styles/components/main.min.css -->
        <link rel="stylesheet" href="styles/h5bp.css">
        <link rel="stylesheet" href="styles/components/components.css">
        <link rel="stylesheet" href="styles/main.css">
        <style>
            @font-face {
                font-family: 'Fake Hindi'; src: url('SAMARN__.TTF')
            
            }

            a {
                text-decoration: none;
            }

            a:visited {
                text-decoration: none;
                color:rgb(36, 96, 219);
            }

            a .button--primary:visited {
                color:white;
            }


            .responsive-object {
              position: relative;
              padding-bottom: 67.5%;
              height: 0;
              margin: 10px 0;
              overflow: hidden;
            }
            .responsive-object iframe,
              .responsive-object object,
              .responsive-object embed {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
            }

            iframe {
              width:100%;
            }

            body {
              /*background-image: url('https://s3.amazonaws.com/ooomf-com-files/cWT6BHfQDW5yDoN1qgn0_DSC06383.png');*/
              /*background-size: cover;*/
            }

            .addBar {
              border-radius: 6px;
              width: 100%;
              padding: 10px;
              border:1px solid grey;
              margin-top: 15px;
              height: 40px;

            }

            .addBar:focus {
              outline-color: transparent;
              outline-style: none;

            }

            .successBox {
              color:green;
              font-weight: 700;

            }

        
        </style>
        <!-- endbuild -->
    </head>
    <body>
<!--         <header class="app-bar promote-layer">
            <div class="app-bar-container">
                <button class="menu"><img src="images/hamburger.svg"></button>
                <h1 class="logo" style="font-weight:bold; font-family:'Fake Hindi';">INDIA NEWS</h1>



                <section class="app-bar-actions">
                </section>
            </div>
        </header> -->

        <nav class="navdrawer-container promote-layer">
            <h4>YouParty</h4>
            <ul>
                <li><a href="#">Today</a></li>
                <li><a href="/politics">Politics</a></li>
            </ul>
        </nav>
        <br />

        <main>
           <section class="styleguide__editorial-header">
            <div>
                <div class="container">
                    <h2 id="partyName" style="text-transform:uppercase; font-weight:700;">{PARTY NAME}</h2>
                    <input type="text" class="addBar" placeholder="Type any YouTube URL (hit enter/return to add it)"/>
                    <div class="successBox">Successfully added to queue.</div>
                    <!-- <div id="searchResults">

                    </div> -->
                    <p class="editorial-header__excerpt g-wide--pull-1">
                    <center><div id="mainVideo"></div></center>

                    <!-- <span class="bannerDate" style="font-weight:bold;"></span><br /><br /> -->
                    <span class="mainVideoContent">
                    Loading...
                    </span> 
                    </p>
                    </span>
                </div>
            </div>
        </section>
           
        </main>




<div style="padding: 20px; background-color:rgb(240, 240, 240);">

        <section class="styleguide__featured-section">
    <div class="featured-section">
        <div class="container-medium">
            <ul class="featured-list upcomingList" style="padding: 40px 0px 30px 0px;">
                
            </ul>
        </div>
    </div>
</section>









<br />
<!-- <div style="width: 100%;"> -->
<!-- </div> -->
<br />




    
</section>
</div>


<div class="footer" style="padding: 40px;">
<center>
Built at Y-Combinator Hackathon.
</center>
</div>







        <!-- build:js scripts/main.min.js -->
        <script src="scripts/main.js"></script>
        <script src="scripts/jquery.min.js"></script>
        <script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
        <script src="http://cdn.embed.ly/jquery.embedly-3.1.1.min.js" type="text/javascript"></script>
        <script src="https://cdn.firebase.com/js/client/1.0.18/firebase.js"></script>
        <script src="http://www.youtube.com/player_api"></script>
        <!-- // <script type="text/javascript" src="//cdn.embed.ly/player-0.0.10.min.js"></script> -->

        <script>
        var url = document.URL;
        var room = url.replace('http://4e72255c.ngrok.com/', '');

        $("#partyName").html(room);

        $(".successBox").hide();

        var fb = new Firebase('https://youparty.firebaseio.com/playlists/'+ room); //+ //room.toLowerCase());

        var currentTime = 0;
        var currentVid = 0;
        var numShifted = 0;

        //fb.child("videos").on("child_added", function (s) {console.log(s.val())})


        var videos = []; //['https://www.youtube.com/watch?v=0Bmhjf0rKe8', 'https://www.youtube.com/watch?v=9bZkp7q19f0', 'https://www.youtube.com/watch?v=3ahoqR6OGdM', 'https://www.youtube.com/watch?v=hL5nTprjOZQ', 'https://www.youtube.com/watch?v=--MSSAiEcT0', 'https://www.youtube.com/watch?v=98BIu9dpwHU', 'https://www.youtube.com/watch?v=3ahoqR6OGdM'];
        var videoHistory = [];

        var firstVideo = false;

        fb.child("videos").on("child_added", function (data) {
          // if (numShifted == 0) 
          // {
            videos.push('https://www.youtube.com/watch?v=' + data.val().url);
          // } else {
          //   for (var i = 0; )
          // }
          


          if (firstVideo === false) {
            firstVideo = true;

            $.ajax({
                url: '//api.embed.ly/1/oembed?url=https://www.youtube.com/watch?v='+ data.val().url +'&key=422cb5607e3d4623949d4360ade230c9',
                dataType: 'json',
                async: false,
                success: function(s) {


                  // $(".mainVideo").html(data.html);
                  $(".mainVideoContent").html(s.description);

                }
              });



          } else {

            $.ajax({
                  url: '//api.embed.ly/1/oembed?url=https://www.youtube.com/watch?v='+ data.val().url +'&key=422cb5607e3d4623949d4360ade230c9',
                  dataType: 'json',
                  async: false,
                  success: function(s) {
                    var img = grabVideoThumbnail(s.url);

                    $(".upcomingList").append('<li class="featured-list__item clear"><div class="container-small"><div class="featured-list__content g--half"><h3><a href="#" class="oneLink"><span class="oneTitle">'+ s.title +'</span></a></h3><p class="oneContent">' + s.description + '</p></div><div class="featured-list__img-wrapper g--half g--last"><div class="featured-list__img"><img src="'+ img +'" alt="image exemple" style="border-radius: 3px;width:100%;"></div></div></div></li>');
                  }
            });
        }
 
        fb.child("videoHistory").on("value", function (data) {
          videoHistory.push(data.val().url);
        });



          // console.log(JSON.stringify(data.val()));
          // console.log(videos);
          

          // onYouTubePlayer();

          // onYouTubePlayerAPIReady();


        });

        // fb.child("videos").on("value", function (data) {
          // parseVideo(videos);
        // });






        // var player = new playerjs.Player('iframe');


        function parseVideo(testVideos) {
          $(".upcomingList").html("");

          for (var i = 0; i < testVideos.length; i++) {
            if (i == 0) {
              $.ajax({
                url: '//api.embed.ly/1/oembed?url='+ testVideos[i] +'&key=422cb5607e3d4623949d4360ade230c9',
                dataType: 'json',
                async: false,
                success: function(data) {


                  // $(".mainVideo").html(data.html);
                  $(".mainVideoContent").html(data.description);

                }
              });

              // $.getJSON('//api.embed.ly/1/oembed?url='+ testVideos[i] +'&key=ffd2e1e42dc24e5692dddf0136272061', function (data) {
        
              //     $(".mainVideo").html(data.html);
              //     $(".mainVideoContent").html(data.description);
                
              // }); 

            } else {
          


              
              // $.getJSON('//api.embed.ly/1/oembed?url='+ testVideos[i] +'&key=ffd2e1e42dc24e5692dddf0136272061', function (data) {

              //   // $(".upcomingList").append("<li>yo</li>");
              //     // alert(JSON.stringify(data));
              //     // alert(data.original_url);
                  
              //   }); 
            }
          }
          
        }


      
        // create youtube player
        var player;

        // onYouTubePlayerAPIReady(extractParameters(videos[0])["v"]);


        function onYouTubePlayerAPIReady() {


            player = new YT.Player('mainVideo', {
              height: '390',
              width: '640',
              // videoId: extractParameters(videos[0])["v"],
              events: {
                'onReady': onPlayerReady,
                'onStateChange': function (event) {    
                // alert(eventData.);  
                  // alert(event.data);
                    // if (event.data === 1) {
                     
                    // }

                    if(event.data === 0) {
                        // alert(typeof videos);
                        

                        if (videos.length != 0) {
                          videoHistory.push(videos[0]);
                          videos.shift();


                          // fb.child("videos").limit(1).remove();

                          if (videos.length == 0) {
                            videos = videoHistory;
                            videoHistory = [];
                            // alert(videos);
                          }
                        }
                      
                        
                        // parseVideo(videos);
                        $(".upcomingList").html("");

                        for (var i = 1; i < videos.length; i++) {
                          $.ajax({
                                url: '//api.embed.ly/1/oembed?url='+ videos[i] +'&key=422cb5607e3d4623949d4360ade230c9',
                                dataType: 'json',
                                async: false,
                                success: function(s) {
                                  var img = grabVideoThumbnail(s.url);

                                  $(".upcomingList").append('<li class="featured-list__item clear"><div class="container-small"><div class="featured-list__content g--half"><h3><a href="#" class="oneLink"><span class="oneTitle">'+ s.title +'</span></a></h3><p class="oneContent">' + s.description + '</p></div><div class="featured-list__img-wrapper g--half g--last"><div class="featured-list__img"><img src="'+ img +'" alt="image exemple" style="border-radius: 3px;width:100%;"></div></div></div></li>');
                                }
                          });
                        }


                        $.ajax({
                          url: '//api.embed.ly/1/oembed?url='+ videos[0] +'&key=422cb5607e3d4623949d4360ade230c9',
                          dataType: 'json',
                          async: false,
                          success: function(data) {


                            // $(".mainVideo").html(data.html);
                            $(".mainVideoContent").html(data.description);

                          }
                        });

                        // console.log(currentVid);
                        player.loadVideoById(extractParameters(videos[0])["v"], 0, "large");

                    }
                }



              }
            });
        }


        // autoplay video
        function onPlayerReady(event) {

            if (currentVid == 0) {
              setTimeout(function() { player.loadVideoById(extractParameters(videos[0])["v"], Math.round(Number(currentTime)), "large");}, 200);
            } else {
              setTimeout(function() { player.loadVideoById(currentVid, Math.round(Number(currentTime)), "large");}, 200);
            }

            event.target.playVideo();
        }

        // when video ends
        function onPlayerStateChange(event) {    
        // alert(eventData.);    
            if(event.data === 0) {

                videos.shift();

                parseVideo(videos);

                player.loadVideoById(extractParameters(videos[0])["v"], 5, "large")

            }
        }




        // 
          // }


        // }

        
        // alert(parseVideo('https://www.youtube.com/watch?v=3ahoqR6OGdM', false));

        function extractParameters(url)
        {
          var query = url.match(/.*\?(.*)/)[1];
          var assignments = query.split("&");
          var pair, parameters = {};
          for (var ii = 0; ii < assignments.length; ii++)
          { 
              pair = assignments[ii].split("=");
              parameters[pair[0]] = pair[1];
          }
          return parameters;
        }

        


        function grabVideoThumbnail(url) {
          // var videoExtra = url.substring(0, 33);
          // alert(videoID);
          // url = "http://www.youtube.com/watch?v=gkU&list=UUa3Q&feature=plcp";
          video_parameters = extractParameters(url);

          var id = video_parameters["v"];
          // alert(url + ", " + id);

          var src = 'http://i.ytimg.com/vi/' + id + '/hqdefault.jpg';

          return src;

        }


        function searchVideo(query) {
          $.getJSON('http://gdata.youtube.com/feeds/api/videos?q='+ query +'&max-results=50&alt=json', function (data) {

            for (var i = 0; i < 5; i++) {
              var title = data.feed.entry[i].title.$t;

              var url = data.feed.entry[i].link[i].href;
               
              var id = extractParameters(url)["v"];

              var thumb = 'http://i.ytimg.com/vi/' + id + '/hqdefault.jpg';


            }
            
            
          });
        }

        // $(".addBar").focus(function() {
          // alert("Yo");
        // });

        $(document).keydown(function (evt) {
          if (evt.which == 13) {
            if (document.querySelector(".addBar").value.length != 0) { 
              // alert("Yo");
              fb.child("videos").push({'url': extractParameters(document.querySelector(".addBar").value)["v"]})
              document.querySelector(".addBar").value = "";
              $(".successBox").show();
              setTimeout(function() {$(".successBox").fadeOut();}, 100);
            }
          }
        });




        

        // push current time

        
        fb.on("value", function (data) {
          currentTime = data.val().currentVidTime;

          if (currentTime == 0) {
      
       
            setInterval(function() {
            // if (currentTime == 0) {
                fb.child("currentVidTime").set(player.getCurrentTime());
              // }
              // console.log(Math.round(currentTime));
            }, 100);

            fb.child("currentVidTime").onDisconnect().set(0);
          }
        });


        fb.on("value", function (data) {
          currentVid = data.val().currentVid;

          if (currentVid == 0) {
      
       
            setInterval(function() {
            // if (currentTime == 0) {
                fb.child("currentVid").set(extractParameters(player.getVideoUrl())["v"]);
              // }
              // console.log(Math.round(currentTime));
            }, 100);

            fb.child("currentVid").onDisconnect().set(0);
          }
        });


        fb.on("value", function (data) {
          numShifted = data.val().numShifted;

          console.log(videoHistory.length);
          console.log("Yo");
          console.log(numShifted);

          if (numShifted == null || numShifted == 0) {
      
       
            setInterval(function() {
            // if (currentTime == 0) {

                fb.child("numShifted").set(Number(videoHistory.length));
              // }
              // console.log(Math.round(currentTime));
            }, 100);

            fb.child("numShifted").onDisconnect().set(0);
          }
       


       });


        console.log(numShifted);
        for (var i = 0; i < numShifted; i++) {

          console.log(videos.length);
          videos.shift();
          console.log("shifted...");
          console.log(videos.length);
          // parseVideo(videos);

          // parseVideo(videos);

          $(".upcomingList").html("");

          for (var j = 1; j < videos.length; j++) {
            $.ajax({
                  url: '//api.embed.ly/1/oembed?url='+ videos[j] +'&key=422cb5607e3d4623949d4360ade230c9',
                  dataType: 'json',
                  async: false,
                  success: function(s) {
                    var img = grabVideoThumbnail(s.url);

                    $(".upcomingList").append('<li class="featured-list__item clear"><div class="container-small"><div class="featured-list__content g--half"><h3><a href="#" class="oneLink"><span class="oneTitle">'+ s.title +'</span></a></h3><p class="oneContent">' + s.description + '</p></div><div class="featured-list__img-wrapper g--half g--last"><div class="featured-list__img"><img src="'+ img +'" alt="image exemple" style="border-radius: 3px;width:100%;"></div></div></div></li>');
                  }
            });
          }

        }


        // console.log('')


  


        </script>
        <!-- endbuild -->

        <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
        <script>
            (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-167816-1');ga('send','pageview');
        </script>
        <!-- Built with love using Web Starter Kit -->
    </body>
</html>
